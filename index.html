<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Oculus/WebXR • v14 • Per-Eye Brightness/Lift/Contrast/Saturation + LFO + F1</title>
<script type="importmap">
{ "imports": {
  "three":"https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
  "three/addons/":"https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
}}
</script>
<style>
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif}
  #menuToggle{position:fixed;left:-9999px}
  #hamburger{position:fixed;left:16px;top:16px;z-index:2000;width:40px;height:40px;border-radius:10px;border:1px solid rgba(255,255,255,.25);
    background:rgba(0,0,0,.5);color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer}
  #menuToggle:not(:checked)~#controls{opacity:0;transform:translateY(-8px);pointer-events:none}
  #dbg{position:fixed;left:16px;top:64px;z-index:1200;color:#c8ffd9;background:rgba(0,0,0,.45);padding:8px 10px;border-radius:8px;font:12px/1.5 ui-monospace,Consolas,monospace;min-width:320px;pointer-events:none;white-space:pre}
  #seedCanvas{position:fixed;inset:0;display:block;z-index:100;pointer-events:auto;touch-action:none;cursor:crosshair}
  #stage{position:fixed;inset:0;z-index:50}
  #controls{position:fixed;right:20px;top:20px;z-index:1500;background:rgba(0,0,0,.9);color:#fff;min-width:720px;border-radius:14px;padding:16px;border:1px solid rgba(255,255,255,.15);backdrop-filter:blur(8px);transition:.2s;max-height:92vh;overflow:auto}
  #controls h3{margin:0 0 10px;text-align:center;color:#82d0ff}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:6px 0}
  .cols{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .card{border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:10px;background:rgba(255,255,255,.05)}
  .card h4{margin:0 0 8px;color:#ffd166;text-align:center}
  label{display:flex;justify-content:space-between;gap:10px;font-size:12px}
  input[type=range]{width:240px}
  .button{appearance:none;border:0;border-radius:10px;padding:8px 12px;margin:2px 6px 0 0;cursor:pointer;color:#fff;background:#3a86ff}
  .button.stop{background:#c62828}
  .button.ghost{background:rgba(255,255,255,.15)}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.1);font-size:12px;margin-left:6px}
  .value{color:#82d0ff;font-weight:700;margin-left:6px}
</style>
</head>
<body>
  <input type="checkbox" id="menuToggle" checked>
  <label id="hamburger" for="menuToggle" title="컨트롤 패널 토글(F1/H)">☰</label>

  <div id="dbg">[BOOT] 초기화 중…</div>
  <canvas id="seedCanvas"></canvas>
  <div id="stage"></div>

  <div id="controls">
    <h3>Oculus/WebXR · Per-Eye 밝기/리프트/대비/채도 + LFO (v14)</h3>

    <div class="row">시드: <span id="seedVal" class="pill">없음</span> · 점: <span id="ptCount" class="pill">0/7</span></div>

    <div class="row">
      <button id="startBtn" class="button">시작</button>
      <button id="forceBtn" class="button ghost">강제 스폰</button>
      <button id="stopBtn" class="button stop">중지</button>
      <button id="resetBtn" class="button ghost">리셋(점 다시 찍기)</button>
      <button id="enterVR" class="button">Enter VR</button>
    </div>

    <div class="row cols">
      <div class="card">
        <h4>흐름</h4>
        <label>수명(초) <span id="speedVal" class="value">3.0</span><input id="speed" type="range" min="1" max="10" step="0.5" value="3"></label>
        <label>스폰주기(ms) <span id="freqVal" class="value">700</span><input id="freq" type="range" min="100" max="3000" step="50" value="700"></label>
        <label>동시 스폰 <span id="densVal" class="value">3</span><input id="dens" type="range" min="1" max="8" step="1" value="3"></label>
      </div>
      <div class="card">
        <h4>크기</h4>
        <label>기본 폭(px)   <span id="wVal" class="value">48</span><input id="w" type="range" min="16" max="200" value="48"></label>
        <label>기본 높이(px) <span id="hVal" class="value">48</span><input id="h" type="range" min="16" max="200" value="48"></label>
        <label>기본 깊이(px) <span id="dVal" class="value">64</span><input id="d" type="range" min="16" max="240" value="64"></label>
      </div>
    </div>

    <div class="row cols">
      <div class="card">
        <h4>좌안(LEFT)</h4>
        <label>밝기(게인) <span id="gainLV" class="value">160%</span><input id="gainL" type="range" min="50" max="240" step="1" value="160"></label>
        <label>리프트(±) <span id="liftLV" class="value">+0.10</span><input id="liftL" type="range" min="-50" max="50" step="1" value="10"></label>
        <label>대비(배) <span id="contLV" class="value">1.35</span><input id="contL" type="range" min="50" max="220" step="1" value="135"></label>
        <label>채도(배) <span id="satLV" class="value">1.80</span><input id="satL" type="range" min="0" max="300" step="1" value="180"></label>
      </div>
      <div class="card">
        <h4>우안(RIGHT)</h4>
        <label>밝기(게인) <span id="gainRV" class="value">85%</span><input id="gainR" type="range" min="50" max="240" step="1" value="85"></label>
        <label>리프트(±) <span id="liftRV" class="value">-0.05</span><input id="liftR" type="range" min="-50" max="50" step="1" value="-5"></label>
        <label>대비(배) <span id="contRV" class="value">0.90</span><input id="contR" type="range" min="50" max="220" step="1" value="90"></label>
        <label>채도(배) <span id="satRV" class="value">1.00</span><input id="satR" type="range" min="0" max="300" step="1" value="100"></label>
      </div>
    </div>

    <div class="row card">
      <h4>A. 밝기/대비 LFO (per-eye)</h4>
      <div class="cols">
        <div>
          <label>좌 LFO On <input id="lfoAL_on" type="checkbox"></label>
          <label>좌 Lift 진폭(±) <span id="lfoAL_liftV" class="value">0.05</span><input id="lfoAL_lift" type="range" min="0" max="0.5" step="0.01" value="0.05"></label>
          <label>좌 Contrast 진폭(±) <span id="lfoAL_contV" class="value">0.20</span><input id="lfoAL_cont" type="range" min="0" max="1" step="0.01" value="0.20"></label>
          <label>좌 주기(초) <span id="lfoAL_cycV" class="value">8</span><input id="lfoAL_cyc" type="range" min="2" max="60" step="1" value="8"></label>
          <label>좌 파형
            <select id="lfoAL_wave"><option value="sine" selected>Sine</option><option value="tri">Triangle</option><option value="pulse">Pulse</option></select>
          </label>
        </div>
        <div>
          <label>우 LFO On <input id="lfoAR_on" type="checkbox"></label>
          <label>우 Lift 진폭(±) <span id="lfoAR_liftV" class="value">0.05</span><input id="lfoAR_lift" type="range" min="0" max="0.5" step="0.01" value="0.05"></label>
          <label>우 Contrast 진폭(±) <span id="lfoAR_contV" class="value">0.20</span><input id="lfoAR_cont" type="range" min="0" max="1" step="0.01" value="0.20"></label>
          <label>우 주기(초) <span id="lfoAR_cycV" class="value">10</span><input id="lfoAR_cyc" type="range" min="2" max="60" step="1" value="10"></label>
          <label>우 파형
            <select id="lfoAR_wave"><option value="sine" selected>Sine</option><option value="tri">Triangle</option><option value="pulse">Pulse</option></select>
          </label>
        </div>
      </div>
    </div>
  </div>

<script type="module">
import * as THREE from 'three';
import { VRButton } from 'three/addons/webxr/VRButton.js';

const $=id=>document.getElementById(id);
const dbg=$('dbg'); const say=s=>{dbg.textContent=s; console.log(s);};
const can=$('seedCanvas'), ctx=can.getContext('2d');
const state={points:[], seed:null, palette:[], running:false};

function fit2D(){ can.width=innerWidth; can.height=innerHeight; drawPts(); }
function drawPts(){
  ctx.clearRect(0,0,can.width,can.height);
  ctx.fillStyle='#ffee66'; state.points.forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,6,0,Math.PI*2);ctx.fill();});
  if(state.points.length===7){ctx.strokeStyle='#ffeb3b';ctx.lineWidth=2;let i=0;ctx.beginPath();ctx.moveTo(state.points[i].x,state.points[i].y);for(let k=0;k<7;k++){i=(i+2)%7;ctx.lineTo(state.points[i].x,state.points[i].y);}ctx.closePath();ctx.stroke();}
}
function rel(e){const r=can.getBoundingClientRect();const p=(e.touches?e.touches[0]:e);return {x:p.clientX-r.left,y:p.clientY-r.top};}
let lock=0,last={x:-1e9,y:-1e9};
function addPt(p){const dx=p.x-last.x,dy=p.y-last.y;if(dx*dx+dy*dy<25)return;if(state.points.length>=7)return;state.points.push(p);last=p;$('ptCount').textContent=state.points.length+'/7';drawPts();if(state.points.length===7)buildPalette(false);}
function onDown(e){ if(e.target.closest && e.target.closest('#controls')) return; if(can.style.display==='none') return; const now=performance.now(); if(now<lock) return; lock=now+80; addPt(rel(e)); e.preventDefault?.(); }
['pointerdown','mousedown','click','touchstart'].forEach(ev=>can.addEventListener(ev,onDown,{passive:false}));
window.addEventListener('resize', fit2D, {passive:true}); fit2D();

function hslToHex(h,s,l){
  const c=(1-Math.abs(2*l-1))*s, hp=((h%360)+360)%360/60, x=c*(1-Math.abs(hp%2-1));
  let r=0,g=0,b=0;
  if(hp<1){r=c;g=x;} else if(hp<2){r=x;g=c;} else if(hp<3){g=c;b=x;}
  else if(hp<4){g=x;b=c;} else if(hp<5){r=x;b=c;} else {r=c;b=x;}
  const m=l-c/2; r=Math.round((r+m)*255); g=Math.round((g+m)*255); b=Math.round((b+m)*255);
  return "#"+((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1);
}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^(t>>>15),t|1);t^=t+Math.imul(t^(t>>>7),t|61);return ((t^(t>>>14))>>>0)/4294967296;};}
function computeSeed(){let s=0;state.points.forEach((p,i)=>{s^=(((p.x|0)+(p.y|0))<<(i%24));});return (s>>>0)||0xA5A5A5A5;}
function buildPalette(forceRandom){
  state.seed = (forceRandom && state.points.length<7)?((Math.random()*0xffffffff)>>>0):computeSeed();
  $('seedVal').textContent=String(state.seed);
  const rng=mulberry32(state.seed||0xA5A5A5A5), base=Math.floor(rng()*360), N=220, arr=[];
  for(let i=0;i<N;i++){
    const h=(base+i*(360/N)+(rng()*2-1)*10+360)%360, s=0.7+rng()*0.25, l=0.78+rng()*0.10;
    arr.push(hslToHex(h,Math.min(0.95,Math.max(0.55,s)),Math.min(0.9,Math.max(0.65,l))));
  }
  state.palette=arr; say(`[SEED] 팔레트 ${N}색`);
}

/* ---------- UI ---------- */
function bindVal(id, fmt=(v)=>v){ const el=$(id), out=$(id+'Val')||$(id.replace(/.$/,'V')); const f=()=>{ if(out){out.textContent=fmt(el.value);} }; el.addEventListener('input',f); el.addEventListener('change',f); f(); return el; }
const speed=bindVal('speed',v=>Number(v).toFixed(1)), freq=bindVal('freq'), dens=bindVal('dens');
const w=bindVal('w'), h=bindVal('h'), d=bindVal('d');
const gainL=bindVal('gainL',v=>v+'%'), gainR=bindVal('gainR',v=>v+'%');
const liftL=bindVal('liftL',v=>(Number(v)>=0?'+':'')+(Number(v)/100).toFixed(2)), liftR=bindVal('liftR',v=>(Number(v)>=0?'+':'')+(Number(v)/100).toFixed(2));
const contL=bindVal('contL',v=>(Number(v)/100).toFixed(2)), contR=bindVal('contR',v=>(Number(v)/100).toFixed(2));
const satL=bindVal('satL',v=>(Number(v)/100).toFixed(2)), satR=bindVal('satR',v=>(Number(v)/100).toFixed(2));
const lfoAL_on=$('lfoAL_on'), lfoAR_on=$('lfoAR_on');
const lfoAL_lift=bindVal('lfoAL_lift',v=>Number(v).toFixed(2)), lfoAR_lift=bindVal('lfoAR_lift',v=>Number(v).toFixed(2));
const lfoAL_cont=bindVal('lfoAL_cont',v=>Number(v).toFixed(2)), lfoAR_cont=bindVal('lfoAR_cont',v=>Number(v).toFixed(2));
const lfoAL_cyc=bindVal('lfoAL_cyc'), lfoAR_cyc=bindVal('lfoAR_cyc');
const lfoAL_wave=$('lfoAL_wave'), lfoAR_wave=$('lfoAR_wave');
function wave(shape, phase){ const x=phase-Math.floor(phase); if(shape==='sine') return Math.sin(x*2*Math.PI); if(shape==='tri') return 4*Math.abs(x-0.5)-1; if(shape==='pulse') return (x<0.5)?1:-1; return 0; }

/* ---------- THREE / WebXR ---------- */
const stage=$('stage');
const renderer=new THREE.WebGLRenderer({antialias:true,alpha:false});
renderer.setPixelRatio(Math.min(devicePixelRatio||1,1.8));
renderer.setSize(innerWidth,innerHeight);
renderer.outputColorSpace=THREE.SRGBColorSpace;
renderer.toneMapping=THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure=1.0;
renderer.xr.enabled=true;
renderer.xr.setReferenceSpaceType('local-floor');
stage.appendChild(renderer.domElement);

const scene=new THREE.Scene(); scene.background=new THREE.Color(0x000000);
const cam=new THREE.PerspectiveCamera(55,innerWidth/innerHeight,0.1,2000); cam.position.set(0,1.45,4); scene.add(cam);

scene.add(new THREE.AmbientLight(0xffffff,0.7));
const dir=new THREE.DirectionalLight(0xffffff,1.1); dir.position.set(2.2,4.0,2.8); scene.add(dir);

const group=new THREE.Group(); scene.add(group); let cubes=[];

function colorFromPalette(rng){ return new THREE.Color(state.palette[Math.floor(rng()*state.palette.length)]||'#ffffff'); }
function makeMat(color){
  const m=new THREE.MeshStandardMaterial({color, metalness:0.04, roughness:0.42, transparent:true, opacity:1.0, emissive:color.clone().multiplyScalar(0.06), emissiveIntensity:0.22});
  m.onBeforeCompile=(shader)=>{
    shader.uniforms.uSat={value:1.0};
    shader.uniforms.uGain={value:1.0};
    shader.uniforms.uLift={value:0.0};
    shader.uniforms.uContrast={value:1.0};
    m.userData.shader=shader;
    shader.fragmentShader=shader.fragmentShader.replace(
      'gl_FragColor = vec4( outgoingLight, diffuseColor.a );',
      `
      float luma = dot(outgoingLight, vec3(0.299,0.587,0.114));
      vec3 col = mix(vec3(luma), outgoingLight, uSat);
      col = (col - 0.5) * uContrast + 0.5;
      col += uLift;
      col *= uGain;
      col = clamp(col, 0.0, 1.0);
      gl_FragColor = vec4(col, diffuseColor.a);
      `
    );
  };
  m.customProgramCacheKey=()=>'sat_gain_lift_contrast_v14';
  return m;
}

function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^(t>>>15),t|1);t^=t+Math.imul(t^(t>>>7),t|61);return ((t^(t>>>14))>>>0)/4294967296;};}
function createBox(rng){
  const g=new THREE.BoxGeometry(Number(w.value),Number(h.value),Number(d.value));
  const mesh=new THREE.Mesh(g, makeMat(colorFromPalette(rng)));
  const zStart=-18-rng()*8, xStart=(rng()-0.5)*3.2, yStart=(rng()-0.5)*2.2;
  mesh.position.set(xStart,yStart,zStart);
  mesh.rotation.set(rng()*Math.PI, rng()*Math.PI, rng()*Math.PI);

  const life=Number(speed.value), zEnd=3.0, velZ=(zEnd - zStart)/Math.max(life,0.5);
  const velX=(rng()*0.18-0.09), swayA=0.06+rng()*0.12, swayHz=0.45+rng()*0.65;

  let leftUUID=null, rightUUID=null;
  mesh.onBeforeRender=(renderer,scene,camera)=>{
    // 현재 카메라가 어떤 눈인지 식별
    const xrCam=renderer.xr.getCamera(cam);
    leftUUID  = leftUUID  || (xrCam.cameras[0]?.uuid||null);
    rightUUID = rightUUID || (xrCam.cameras[1]?.uuid||null);
    const isLeft=(camera.uuid===leftUUID);
    // per-eye 파라미터(정적 + LFO)
    function params(side){
      const sat = Number(side==='L'?satL.value:satR.value)/100;
      const gain= Number(side==='L'?gainL.value:gainR.value)/100;
      const lift= Number(side==='L'?liftL.value:liftR.value)/100;
      const cont= Number(side==='L'?contL.value:contR.value)/100;
      let uLift=lift, uCont=cont;
      const t=performance.now()/1000;
      if(side==='L' && $('lfoAL_on').checked){
        const v=wave($('lfoAL_wave').value, t/Math.max(0.5, Number($('lfoAL_cyc').value)));
        uLift += Number($('lfoAL_lift').value)*v;
        uCont += Number($('lfoAL_cont').value)*v;
      }
      if(side==='R' && $('lfoAR_on').checked){
        const v=wave($('lfoAR_wave').value, t/Math.max(0.5, Number($('lfoAR_cyc').value)));
        uLift += Number($('lfoAR_lift').value)*v;
        uCont += Number($('lfoAR_cont').value)*v;
      }
      return {sat:Math.max(0, sat), gain:Math.max(0, gain), lift:uLift, cont:Math.max(0.3, uCont)};
    }
    const p = params(isLeft?'L':'R');
    const sh=mesh.material.userData.shader; if(sh){ sh.uniforms.uSat.value=p.sat; sh.uniforms.uGain.value=p.gain; sh.uniforms.uLift.value=p.lift; sh.uniforms.uContrast.value=p.cont; }
  };

  mesh.userData={zEnd,velZ,velX,yBase:yStart,swayA,swayHz,phase:rng()*Math.PI*2,dieAt:performance.now()+life*1000,lifeTotal:life*1000};
  group.add(mesh); cubes.push(mesh);
}

/* ---------- 스폰/루프 ---------- */
function spawn(now, mul=1){
  if(!state.running || !state.palette.length) return;
  const base=(state.seed^(now|0))>>>0; const rng=mulberry32(base);
  const n=Number(dens.value)*mul; for(let i=0;i<n;i++) createBox(rng);
}

let prev=performance.now(), lastSpawn=0;
function loop(now){
  const dt=Math.min((now-prev)/1000,0.05); prev=now;

  if(state.running && now-lastSpawn>=Number(freq.value)){ spawn(now,1); lastSpawn=now; }
  if(state.running && state.palette.length && cubes.length===0){ spawn(now,2); }

  const t=performance.now();
  for(let i=cubes.length-1;i>=0;i--){
    const m=cubes[i], u=m.userData;
    m.rotation.x += 0.52*dt; m.rotation.y += 0.46*dt;
    u.phase += dt*2*Math.PI*u.swayHz;
    m.position.z += u.velZ*dt; m.position.x += u.velX*dt; m.position.y = u.yBase + Math.sin(u.phase)*u.swayA;
    let alpha=THREE.MathUtils.clamp((u.dieAt - t)/u.lifeTotal,0,1);
    if(m.position.z>=u.zEnd){ alpha *= (1 - THREE.MathUtils.clamp((m.position.z - u.zEnd)/0.8,0,1)); }
    m.material.opacity=alpha;
    if(alpha<=0.01 || t>=u.dieAt || m.position.z>u.zEnd+1.0){ group.remove(m); m.geometry.dispose(); m.material.dispose(); cubes.splice(i,1); }
  }

  renderer.render(scene, cam);
  dbg.textContent=`[${renderer.xr.isPresenting?'XR':'MONO'}] cubes=${cubes.length}`;
}
renderer.setAnimationLoop(loop);

/* ---------- 버튼/키 & VR ---------- */
function ensureReady(){
  if(!state.palette.length) buildPalette(state.points.length<7);
  state.running=true; can.style.display='none';
}
$('startBtn').onclick=()=>{ ensureReady(); spawn(performance.now(),4); lastSpawn=performance.now()-Number(freq.value); };
$('forceBtn').onclick=()=>{ ensureReady(); spawn(performance.now(),4); };
$('stopBtn').onclick=()=>{ state.running=false; };
$('resetBtn').onclick=()=>{ state.running=false; state.seed=null; state.palette=[]; state.points=[]; $('ptCount').textContent='0/7'; $('seedVal').textContent='없음'; can.style.display='block'; drawPts(); };

function togglePanel(){ const box=$('menuToggle'); box.checked=!box.checked; }
document.addEventListener('keydown', (e)=>{
  if(e.target && (e.target.tagName==='INPUT' || e.target.tagName==='TEXTAREA')) return;
  if(e.key==='F1' || e.key==='h' || e.key==='H'){ e.preventDefault(); togglePanel(); }
});

const vrBtn = VRButton.createButton(renderer);
vrBtn.style.position='fixed'; vrBtn.style.right='16px'; vrBtn.style.top='16px'; vrBtn.style.zIndex='2001';
document.body.appendChild(vrBtn);
$('enterVR').onclick=()=> vrBtn.click();

renderer.xr.addEventListener('sessionstart', ()=>{
  if(!state.palette.length) buildPalette(true);
  state.running=true; can.style.display='none';
  spawn(performance.now(),4); lastSpawn=performance.now()-Number(freq.value);
  say('[XR] 자동 실행/스폰');
});

say('[READY] 7점 찍고 시작(F1/H=패널 토글). HTTPS에서 테스트하세요.');
</script>
</body>
</html>
